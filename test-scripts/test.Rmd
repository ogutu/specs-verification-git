% The **SpecsVerification** package: Verification of ensemble hindcasts and more
% Stefan Siegert
% January 2014

```{r, echo=FALSE}
opts_chunk$set(tidy=FALSE, dev="pdf")
```


# Install and load

```{r}
install.packages("/home/stefan/folders/specs/r-package/specs-verification-git", 
                 repo=NULL, lib="/tmp", type="source")
library("SpecsVerification", lib.loc="/tmp")
```


# Load some example data

We will use seasonal ensemble forecast of surface temperature averaged over the `Atl3` region between 1993 and 2009, initialized twice a year (1 May and 1 November) and run 1 up to 4 months into the future.
"Observations" are generated from the `ERAint` data set. 
Ensemble forecasts are generated by `ECMWF System4` (15 members) and an anomaly initialized ensemble generated at IC3.
The data can be downloaded from the SPECS wiki: [Atl3.ERAint.Rdata](http://www.specs-fp7.eu/wiki/images/a/a8/Atl3.ERAint.Rdata)



```{r}
file <- "Atl3.ERAint.Rdata"
if (!file.exists(file)) {
  download.file(url="http://www.specs-fp7.eu/wiki/images/a/a8/Atl3.ERAint.Rdata", 
                destfile=file)
}
load(file)

dimnames(obs) # the dimensions of obs are 1:initdate, 2:leadtime
dimnames(ens) # the dimensions of ens are 1:initdate, 2:leadtime, 3:ensemble, 4:member
```

```{r plot-ens-ver, fig.width=6, fig.height=4, fig.cap="Time series of the ensemble data and observations"}
t <- paste(seq.Date(from=as.Date("1993-05-01"), 
           to=as.Date("2009-05-01"), by="1 year"))
ecmwf <- ens[t,"1","ecmwf",]
l00w <- ens[t,"1","l00w",1:5]
ver <- obs[t,"1"]
plot(NULL, xlim=c(1, length(ver)), ylim=range(c(ver,l00w,ecmwf)), 
     xlab="time", ylab="Atl3 temp. [C]")
points(ver, pch=15, cex=1.5, col=gray(.5))
for (i in 1:nrow(ecmwf)) points(rep(i-.2,15), ecmwf[i,], pch=15, cex=0.5)
for (i in 1:nrow(ecmwf)) lines(rep(i-.2,2), range(ecmwf[i,]))
for (i in 1:nrow(l00w)) points(rep(i+.2,5), l00w[i,], pch=16, cex=0.5)
for (i in 1:nrow(l00w)) lines(rep(i+.2,2), range(l00w[i,]))
```

# Fair Brier Score analysis

The function `FairBrier` returns individual values of fair Brier scores of ensembles and their verifications. The argument `tau` is the threshold to whose exceedance defines the binary event:

```{r plot-fbr, fig.width=4, fig.height=3, fig.cap="Plot of fair Brier Scores of ECMWF (gray) and l00w (black)."}
fbr.ecmwf <- FairBrier(ens=ecmwf, obs=ver, tau=28.5)
fbr.l00w <- FairBrier(ens=l00w, obs=ver, tau=28.5)
plot(fbr.ecmwf, type="b", pch=15, col=gray(.5))
lines(fbr.l00w, type="b", pch=16, col="black")
print(c(mean(fbr.ecmwf), mean(fbr.l00w)))
```

The function `AnalyzeFairBrier` returns the mean fair Brier score difference and optional estimated quantiles of the sampling distribution of the mean difference:

```{r}
FairBrierDiff(ens=l00w, ens.ref=ecmwf, obs=ver, 
                 tau=28.5, probs=c(0.05, 0.95))
```


# Fair CRPS analysis

The fair continuously ranked probability score for ensemble forecasts has similar routines as the fair Brier score:

```{r plot-fcrps, fig.width=4, fig.height=3, fig.cap="Plot of fair CRPS of ECMWF (gray) and l00w (black)."}
fcrps.ecmwf <- FairCrps(ens=ecmwf, obs=ver)
fcrps.l00w <- FairCrps(ens=l00w, obs=ver)
plot(fcrps.ecmwf, type="b", pch=15, col=gray(.5))
lines(fcrps.l00w, type="b", pch=16, col="black")
print(c(mean(fcrps.ecmwf), mean(fcrps.l00w)))
print(FairCrpsDiff(ens=l00w, ens.ref=ecmwf, obs=ver, probs=c(0.05, 0.95)))
```


# Rank histogram analysis

**fix the margin issue!!!**

The ECMWF ensemble and the observations are transformed to anomalies by centering them around zero. Then the rank histogram is drawn in the "raw" version and on probability paper:

```{r rankhist, fig.width=4, fig.height=4}
ecmwf <- ens[,1,"ecmwf",]
ecmwf <- ecmwf - mean(ecmwf)
ver <- obs[,1]
ver <- ver - mean(ver)
rh <- Rankhist(ens=ecmwf, obs=ver)
PlotRankhist(rh, mode="raw")
PlotRankhist(rh, mode="prob.paper")
```


# Reliability diagram analysis

The experimental l00w ensemble and the observations are transformed to anomalies. The event of interest is the exceedance of a value of 1 and probabilities are generated for this event by counting ensemble members:


```{r reldiag, fig.width=4, fig.height=4}
l00w <- ens[,4,"l00w",]
l00w <- l00w - mean(l00w, na.rm=TRUE)
p <- rowMeans(l00w > 1, na.rm=TRUE)
ver <- obs[,4]
ver <- ver - mean(ver)
y <- 1 * (ver > 1)
rd <- ReliabilityDiagram(probs=p, obs=y, bins=c(0,1/3,2/3,1), plot=TRUE, nboot=10000, mc.cores=8)
print(rd)
```


